<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archiver - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .dashboard-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-content p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Navigation */
        .dashboard-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none; /* Added for links */
            display: inline-block; /* Added for links */
        }

        .nav-btn.active, .nav-btn:hover {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #6a11cb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Carousel Styles */
        .carousel-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .see-all {
            color: #6a11cb;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none; /* Added for links */
        }
        .see-all:hover {
            text-decoration: underline;
        }

        .carousel-container {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            scrollbar-width: thin;
            scrollbar-color: #6a11cb transparent;
        }

        .carousel-container::-webkit-scrollbar {
            height: 6px;
        }

        .carousel-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .carousel-container::-webkit-scrollbar-thumb {
            background: #6a11cb;
            border-radius: 3px;
        }

        .movie-card {
            min-width: 200px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .movie-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .poster-container {
            position: relative;
            height: 280px;
            overflow: hidden;
        }

        .movie-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .rating-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .rating-max {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .movie-info {
            padding: 1rem;
        }

        .movie-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .movie-meta {
            display: flex;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .votes {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Archive Styles */
        .archive-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .archive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .archive-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .archive-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        .archive-poster {
            width: 50px;
            height: 70px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .archive-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .archive-info {
            flex: 1;
            min-width: 0;
        }

        .archive-info .movie-title {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .movie-year {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Analytics Section */
        .analytics-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analytics-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .bar-chart-container {
            overflow-x: auto;
        }

        .bar-chart {
            min-width: 600px;
            height: 200px;
        }

        .bar {
            fill: url(#barGradient);
            transition: all 0.3s ease;
        }

        .bar:hover {
            fill: url(#barGradientHover);
            filter: brightness(1.2);
        }

        .bar-label {
            font-size: 10px;
            fill: rgba(255, 255, 255, 0.8);
            text-anchor: middle;
        }

        .bar-value {
            font-size: 12px;
            fill: white;
            font-weight: 600;
            text-anchor: middle;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .modal-poster {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-poster img {
            max-width: 300px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-details h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-meta {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .modal-meta span {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .prediction-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .prediction-info h3 {
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .prediction-rating {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }

        .rating-value {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .rating-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .confidence {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-primary, .btn-secondary {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 2rem;
            font-style: italic;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .dashboard-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .header-content h1 {
                font-size: 2rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .modal-details h2 {
                font-size: 1.5rem;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .archive-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .movie-card {
                min-width: 160px;
            }
            
            .dashboard-nav {
                overflow-x: auto;
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-content">
                <h1>Welcome to Archiver</h1>
                <p>Your personal movie recommendation engine</p>
            </div>
            <div class="user-info">
                <div class="user-avatar">U</div>
                <div>
                    <!-- This will be filled by JS -->
                    <div id="userEmail"></div> 
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7)">User ID: <span id="userIdDisplay">...</span></div>
                </div>
            </div>
        </header>

        <nav class="dashboard-nav">
            <button class="nav-btn active">Dashboard</button>
            <!-- UPDATED: Changed to an <a> tag -->
            <a href="#" id="navWatchlistBtn" class="nav-btn">My Watchlist</a>
        </nav>

        <main id="dashboardMain">
            <div class="loading-container" id="loadingIndicator">
                <div class="loading-spinner"></div>
                <p>Loading your personalized recommendations...</p>
            </div>

            <div id="recommendationsContent" style="display: none;">
                <section class="carousel-section">
                    <div class="section-header">
                        <h3 class="section-title">Top picks for you</h3>
                        <span class="see-all">See all</span>
                    </div>
                    <div class="carousel-container" id="topPicksCarousel">
                        <!-- Top picks will be populated here -->
                    </div>
                </section>

                <section class="carousel-section">
                    <div class="section-header">
                        <h3 class="section-title">Because you liked similar films</h3>
                        <span class="see-all">See all</span>
                    </div>
                    <div class="carousel-container" id="becauseXCarousel">
                        <!-- Because X items will be populated here -->
                    </div>
                </section>

                <section class="carousel-section">
                    <div class="section-header">
                        <h3 class="section-title">Similar to your favorites</h3>
                        <span class="see-all">See all</span>
                    </div>
                    <div class="carousel-container" id="similarCarousel">
                        <!-- Similar items will be populated here -->
                    </div>
                </section>

                <section class="carousel-section">
                    <div class="section-header">
                        <h3 class="section-title">New & Trending</h3>
                        <span class="see-all">See all</span>
                    </div>
                    <div class="carousel-container" id="trendingCarousel">
                        <!-- Trending items will be populated here -->
                    </div>
                </section>

                <section class="archive-section">
                    <div class="section-header">
                        <h3 class="section-title">Your Watch History</h3>
                        <!-- UPDATED: Changed to an <a> tag -->
                        <a href="#" id="seeAllArchiveBtn" class="see-all">View all</a>
                    </div>
                    <div class="archive-grid" id="archiveGrid">
                        <!-- Archive items will be populated here -->
                    </div>
                </section>

                <section class="analytics-section">
                    <h2>Your Rating Analytics</h2>
                    <div class="bar-chart-container">
                        <svg class="bar-chart" id="analyticsChart">
                            <!-- Gradients will be injected by JS -->
                        </svg>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Movie Detail Modal -->
    <div class="modal-overlay" id="movieModal">
        <div class="modal-content">
            <button class="close-button" id="closeModal">×</button>
            <div class="modal-body">
                <div class="modal-poster">
                    <img id="modalPoster" src="" alt="Movie Poster">
                </div>
                <div class="modal-details">
                    <h2 id="modalTitle">Movie Title</h2>
                    <div class="modal-meta">
                        <span id="modalYear">2023</span>
                        <span id="modalDuration">120 min</span>
                        <span>Rating: <span id="modalRating">8.5</span>/10</span>
                        <span>Votes: <span id="modalVotes">1500</span></span>
                    </div>
                    <div class="prediction-info">
                        <h3>Your Prediction</h3>
                        <div class="prediction-rating">
                            <span class="rating-value" id="modalPredictedRating">8.2</span>
                            <span class="rating-label">Predicted Rating</span>
                        </div>
                        <div class="confidence">
                            Confidence: <span id="modalConfidence">0.85</span>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-primary" id="modalWatchlistBtn">Add to Watchlist</button>
                        <button class="btn-secondary" id="modalRateBtn">Rate This Movie</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

 <script>
    // API configuration
    const API = 'http://127.0.0.1:5000';

    // State variables
    let topPicks = [];
    let becauseX = [];
    let similar = [];
    let trending = [];
    let archive = [];
    let userId = null;
    let currentModalMovieId = null; // Store movie ID for modal actions

    // DOM elements
    const loadingIndicator = document.getElementById('loadingIndicator');
    const recommendationsContent = document.getElementById('recommendationsContent');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const movieModal = document.getElementById('movieModal');
    const closeModal = document.getElementById('closeModal');
    const navWatchlistBtn = document.getElementById('navWatchlistBtn');
    const modalWatchlistBtn = document.getElementById('modalWatchlistBtn');
    const modalRateBtn = document.getElementById('modalRateBtn');
    const seeAllArchiveBtn = document.getElementById('seeAllArchiveBtn');


    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        userId = getUserId();
        if (!userId) {
            alert('User ID not found. Please log in again.');
            window.location.href = 'login.html';
            return;
        }
        
        localStorage.setItem('current_user_id', userId); 
        userIdDisplay.textContent = userId;
        // Optionally display email if stored in localStorage from registration
        document.getElementById('userEmail').textContent = localStorage.getItem('current_user_email') || 'Welcome, User';

        fetchAllData();
        
        // Modal close events
        closeModal.addEventListener('click', closeMovieModal);
        movieModal.addEventListener('click', function(e) {
            if (e.target === movieModal) {
                closeMovieModal();
            }
        });

        // --- UPDATED: "My Watchlist" Button Link ---
        navWatchlistBtn.href = `watchlist.html?user_id=${userId}`;

        // --- UPDATED: "See All" Archive Link ---
        if (seeAllArchiveBtn) {
            seeAllArchiveBtn.href = `archive.html?user_id=${userId}`;
        }
    });

    // Get user ID from localStorage or URL
    function getUserId() {
        const urlParams = new URLSearchParams(window.location.search);
        let id = urlParams.get('user_id');
        if (!id) id = localStorage.getItem('current_user_id'); // Match login.html
        return id;
    }

    // Fetch all dashboard data
    async function fetchAllData() {
        try {
            loadingIndicator.style.display = 'flex'; // Show loader
            recommendationsContent.style.display = 'none'; // Hide content

            const q = `?user_id=${userId}&n=20`;
            const recRes = await fetch(`${API}/api/recommendations${q}`);
            if (!recRes.ok) throw new Error(`Recommendations fetch failed: ${recRes.status}`);
            const recJson = await recRes.json();
            const items = recJson.items || recJson.recommendations || [];

            // Simulate different carousels
            topPicks = items.slice(0, 6);
            becauseX = items.filter((_, i) => i % 5 === 0).slice(0, 6);
            similar = items.filter((_, i) => i % 5 === 1).slice(0, 6);
            trending = items.filter((_, i) => i % 5 === 2).slice(0, 6);

            try {
                const archRes = await fetch(`${API}/api/user/archive?user_id=${userId}`);
                if (!archRes.ok) throw new Error(`Archive fetch failed: ${archRes.status}`);
                const archJson = await archRes.json();
                archive = archJson.archived || []; // Key from app.py
            } catch (e) {
                console.error('Error fetching archive:', e);
                archive = [];
            }

            renderDashboard();
        } catch (e) {
            console.error('Dashboard fetch error', e);
            loadingIndicator.innerHTML = `<p>Error loading recommendations. Please try again. (${e.message})</p>`;
        }
    }

    // Render dashboard
    function renderDashboard() {
        loadingIndicator.style.display = 'none';
        recommendationsContent.style.display = 'block';
        populateCarousel('topPicksCarousel', topPicks);
        populateCarousel('becauseXCarousel', becauseX);
        populateCarousel('similarCarousel', similar);
        populateCarousel('trendingCarousel', trending);
        populateArchive('archiveGrid', archive);
        renderBarChart(topPicks.slice(0, 6)); // Placeholder analytics
    }

    // Populate carousel
    function populateCarousel(carouselId, items) {
        const carousel = document.getElementById(carouselId);
        if (!carousel) return;
        if (!items || items.length === 0) {
            carousel.innerHTML = '<div class="empty-state">No recommendations available</div>';
            return;
        }
        carousel.innerHTML = '';

        items.forEach(item => {
            const movieCard = document.createElement('div');
            movieCard.className = 'movie-card';
            movieCard.addEventListener('click', () => openMovie(item.movie_id));

            movieCard.innerHTML = `
                <div class="poster-container">
                    <img src="${item.poster}" alt="${item.name}" class="movie-poster" 
                         onerror="this.src='https://via.placeholder.com/200x280/333/fff?text=No+Poster'">
                    <div class="rating-badge">
                        ${item.rating || 'N/A'} <span class="rating-max">/10</span>
                    </div>
                </div>
                <div class="movie-info">
                    <h4 class="movie-title">${item.name || 'Unknown'}</h4>
                    <div class="movie-meta">
                        <span>${item.year || '—'}</span>
                        <span>•</span>
                        <span>${item.duration || '—'} min</span>
                    </div>
                    <div class="votes">${item.votes || 0} votes</div>
                </div>
            `;
            carousel.appendChild(movieCard);
        });
    }

    // Populate archive
    function populateArchive(archiveId, items) {
        const archiveGrid = document.getElementById(archiveId);
        if (!archiveGrid) return;
        
        // Sort items by user_rating (desc) for display
        const sortedItems = [...items].sort((a, b) => (b.user_rating || 0) - (a.user_rating || 0));
        
        // Take only the top 6 for the dashboard preview
        const previewItems = sortedItems.slice(0, 6); 

        if (!previewItems || previewItems.length === 0) {
            archiveGrid.innerHTML = '<div class="empty-state">Your archive is empty</div>';
            return;
        }

        archiveGrid.innerHTML = '';
        previewItems.forEach(item => {
            const archiveItem = document.createElement('div');
            archiveItem.className = 'archive-item';
            archiveItem.addEventListener('click', () => openMovie(item.movie_id));

            archiveItem.innerHTML = `
                <div class="archive-poster">
                    <img src="${item.poster}" alt="${item.name}" 
                         onerror="this.src='https://via.placeholder.com/50x70/333/fff?text=No+Poster'">
                </div>
                <div class="archive-info">
                    <h4 class="movie-title">${item.name}</h4>
                    <span class="movie-year">${item.year}</span>
                </div>
            `;
            archiveGrid.appendChild(archiveItem);
        });
    }

    // Open movie modal
    async function openMovie(movieId) {
        try {
            currentModalMovieId = movieId; 

            const m = await fetch(`${API}/api/movie/${movieId}`);
            if (!m.ok) throw new Error(`Movie metadata fetch failed: ${m.status}`);
            const meta = await m.json();
            
            const p = await fetch(`${API}/api/predict?user_id=${userId}&movie_id=${movieId}`);
            if (!p.ok) throw new Error(`Prediction fetch failed: ${p.status}`);
            const pred = await p.json();

            document.getElementById('modalPoster').src = meta.poster || 'https://via.placeholder.com/300x450/333/fff?text=No+Poster';
            document.getElementById('modalTitle').textContent = meta.Name || 'Unknown';
            document.getElementById('modalYear').textContent = meta.year || '—';
            document.getElementById('modalDuration').textContent = `${meta.duration || '—'} min`;
            document.getElementById('modalRating').textContent = meta.Rating || 'N/A'; // This is public rating
            document.getElementById('modalVotes').textContent = meta.Votes || 0;
            
            // FIX: Use ?? to allow 0 as a valid prediction
            document.getElementById('modalPredictedRating').textContent = pred.predicted_rating ?? 'N/A';
            document.getElementById('modalConfidence').textContent = pred.confidence ?? 'N/A';

            modalRateBtn.onclick = () => {
                const ratingValue = prompt("Rate this movie (1–10):");
                const numeric = parseFloat(ratingValue);
                if (!isNaN(numeric) && numeric >= 1 && numeric <= 10) {
                    rateMovie(currentModalMovieId, numeric);
                } else {
                    alert("Please enter a valid rating between 1 and 10.");
                }
            };

            modalWatchlistBtn.onclick = () => {
                addToWatchlist(currentModalMovieId);
            };

            movieModal.style.display = 'flex';
            console.log('movie metadata', meta);
            console.log('predicted rating', pred);
        } catch (error) {
            console.error('Error fetching movie details:', error);
            alert(`Error loading movie details. Please try again. (${error.message})`);
        }
    }

    // Add to Watchlist function
    async function addToWatchlist(movieId) {
        if (!userId) {
            alert("User ID not found. Please log in again.");
            return;
        }
        try {
            const res = await fetch(`${API}/api/watchlist/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: parseInt(userId),
                    movie_id: parseInt(movieId)
                })
            });
            const data = await res.json();
            if (res.ok) {
                alert(data.message || `Movie added to watchlist!`);
            } else {
                alert(`Error: ${data.error || "Could not add to watchlist."}`);
            }
        } catch (err) {
            console.error("Error adding to watchlist:", err);
            alert("Network error. Could not add to watchlist.");
        }
    }


    // Handle rating
    async function rateMovie(movieId, ratingValue) {
        if (!userId) {
            alert("User ID not found. Please log in again.");
            return;
        }
        try {
            const res = await fetch(`${API}/api/rate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: parseInt(userId),
                    movie_id: parseInt(movieId),
                    rating: ratingValue
                })
            });

            const data = await res.json();
            if (res.ok) {
                alert(`Rated ${ratingValue} successfully!`);
                // --- FIX: Update archive UI immediately ---
                updateArchiveUI(movieId, ratingValue);
                
                // --- FIX: Re-fetch recommendations after rating ---
                loadingIndicator.style.display = 'flex';
                recommendationsContent.style.display = 'none';
                await fetchAllData();
                
            } else {
                alert(`${data.error || "Rating failed."}`);
            }
        } catch (err) {
            console.error("Error rating movie:", err);
            alert("Error rating movie.");
        }
    }

    // Helper to update archive UI after rating
    async function updateArchiveUI(movieId, ratingValue) {
        let existingItem = archive.find(item => item.movie_id === movieId);
        
        if (existingItem) {
            existingItem.user_rating = ratingValue;
        } else {
            try {
                const m = await fetch(`${API}/api/movie/${movieId}`);
                if (!m.ok) throw new Error("Failed to fetch movie metadata");
                const meta = await m.json();
                
                archive.unshift({
                    movie_id: meta.movie_id,
                    name: meta.Name,
                    year: meta.year,
                    poster: meta.poster,
                    user_rating: ratingValue
                });

            } catch (e) {
                console.error("Could not fetch metadata for archive update:", e);
                return; 
            }
        }
        
        populateArchive('archiveGrid', archive);
    }


    // Close modal
    function closeMovieModal() {
        movieModal.style.display = 'none';
        currentModalMovieId = null; // Clear the stored ID
    }

    // Render bar chart
    function renderBarChart(data) {
        const svg = document.getElementById('analyticsChart');
        if (!svg) return;
        svg.innerHTML = ''; // Clear previous
        
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        defs.innerHTML = `
            <linearGradient id="barGradient" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#6a11cb" />
                <stop offset="100%" stop-color="#2575fc" />
            </linearGradient>
            <linearGradient id="barGradientHover" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#7d2cff" />
                <stop offset="100%" stop-color="#3d8cff" />
            </linearGradient>
        `;
        svg.appendChild(defs);

        if (!data || data.length === 0) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '50%');
            text.setAttribute('y', '50%');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', 'rgba(255,255,255,0.6)');
            text.textContent = 'No chart data available';
            svg.appendChild(text);
            return;
        }

        const max = Math.max(...data.map(d => parseFloat(d.rating || 0))) || 1;
        const barWidth = 80, spacing = 20;

        data.forEach((d, i) => {
            const val = (parseFloat(d.rating || 0) / max) * 120; // 120px max height
            const x = i * (barWidth + spacing) + spacing;
            
            const barGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            barGroup.setAttribute('class', 'bar-group');
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', String(x));
            rect.setAttribute('y', String(180 - val));
            rect.setAttribute('width', String(barWidth));
            rect.setAttribute('height', String(val));
            rect.setAttribute('rx', "6");
            rect.setAttribute('class', 'bar');
            
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', String(x + barWidth/2));
            label.setAttribute('y', "195");
            label.setAttribute('class', 'bar-label');
            label.textContent = d.name.length > 10 ? d.name.substring(0, 10) + '...' : d.name;

            const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            valueText.setAttribute('x', String(x + barWidth/2));
            valueText.setAttribute('y', String(175 - val));
            valueText.setAttribute('class', 'bar-value');
            valueText.textContent = d.rating;

            barGroup.appendChild(rect);
            barGroup.appendChild(label);
            barGroup.appendChild(valueText);
            svg.appendChild(barGroup);
        });
    }
</script>
</body>
</html>